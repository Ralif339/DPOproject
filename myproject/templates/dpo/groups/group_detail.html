{% extends "manager_navigation.html" %}

{% block title %}–ì—Ä—É–ø–ø–∞{% endblock title %}

{% block style %}

{% endblock style %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header text-white" style="background: #9999FF">
            <h3 class="mb-0 text-center">–ì—Ä—É–ø–ø–∞: {{group.name}}</h3>
        </div>
        <div class="card-body">
            <p><strong>–ö—É—Ä—Å:</strong> {{group.course.course_name}}</p>
            <p><strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> {{group.begin_date}}</p>
            <p><strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> {{group.finish_date}}</p>
            <p><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> {{group.teacher.surname}} {{group.teacher.name}} {{group.teacher.patronymic}}</p>
            <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—à–∞—Ç–µ–ª–µ–π:</strong> <span id="total-students">{{student_count}}</span></p>
            
            <h4 class="mt-4">–°–ø–∏—Å–æ–∫ —Å–ª—É—à–∞—Ç–µ–ª–µ–π</h4>
            <table class="table table-bordered mt-2">
                <thead class="table-dark">
                    <tr class="text-center">
                        <th>‚Ññ</th>
                        <th>–ò–º—è</th>
                        <th>–§–æ—Ä–º–∞ –æ–±—É—á–µ–Ω–∏—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="students-list">
                    {% for student_group in student_groups %}
                        <tr class="text-center">
                            <td>{{ forloop.counter }}</td>
                            <td>{{ student_group.student.surname }} {{ student_group.student.name }} {{ student_group.student.patronymic }}</td>
                            <td>{{ student_group.ed_kind|default:"-" }}</td>
                            <td>
                                <button class="btn btn-danger btn-sm remove-student" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#removeModal"
                                    data-student-id="{{student_group.student.id}}"
                                    data-student-name="{{ student_group.student.surname }} {{ student_group.student.name }}">
                                    –û—Ç—á–∏—Å–ª–∏—Ç—å
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <form id="finish-course-form" method="POST" action="{% url 'finish_course' group.id %}">
                {% csrf_token %}
                <input type="hidden" name="student_ids" id="student-ids">
                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫—É—Ä—Å–∞ -->
                <button type="submit" id="remove-all" class="btn btn-warning mt-3">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∫—É—Ä—Å</button>
            </form>
            
            

            <!-- üîπ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã –æ—Ç—á–∏—Å–ª–µ–Ω–∏—è -->
            <div class="modal fade" id="removeModal" tabindex="-1" aria-labelledby="removeModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="removeModalLabel">–û—Ç—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                        </div>
                        <form method="POST" action="{% url 'group_detail' group.id %}">
                            {% csrf_token %}
                            <div class="modal-body">
                                <p><strong>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç—á–∏—Å–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞?</strong></p>
                                <p id="student-name"></p>

                                <input type="hidden" name="student_id" id="student-id">
                                
                                <div class="mb-3">
                                    <label for="reason" class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—á–∏—Å–ª–µ–Ω–∏—è</label>
                                    <textarea class="form-control" name="reason" id="reason" rows="3" required></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                <button type="submit" class="btn btn-danger">–û—Ç—á–∏—Å–ª–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let removeModal = document.getElementById("removeModal");

        removeModal.addEventListener("show.bs.modal", function (event) {
            let button = event.relatedTarget;
            let studentId = button.getAttribute("data-student-id");
            let studentName = button.getAttribute("data-student-name");

            if (studentId) {
                document.getElementById("student-id").value = studentId;
                document.getElementById("student-name").textContent = "–°—Ç—É–¥–µ–Ω—Ç: " + studentName;
            } else {
                console.error("–û—à–∏–±–∫–∞: studentId –Ω–µ –Ω–∞–π–¥–µ–Ω");
            }
        });
    });
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∫—É—Ä—Å"
    document.getElementById("remove-all").addEventListener("click", function () {
        let studentIds = [];
        let studentRows = document.querySelectorAll("#students-list tr");

        studentRows.forEach(row => {
            let studentId = row.querySelector(".remove-student").getAttribute("data-student-id");
            if (studentId) {
                studentIds.push(studentId);
            }
        });

        if (studentIds.length === 0) {
            alert("–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç—á–∏—Å–ª–µ–Ω–∏—è.");
            return;
        }

        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º ID –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
        document.getElementById("student-ids").value = JSON.stringify(studentIds);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        document.getElementById("finish-course-form").submit();
    });
</script>
{% endblock content %}